<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RE4 CIRCUIT FIX</title>
    <style>
        :root {
            --re-green: #3cf08d;
            --re-dim: #163a24;
            --bg-black: #050806;
        }

        body {
            background-color: var(--bg-black);
            color: var(--re-green);
            font-family: 'Courier New', monospace;
            display: flex; flex-direction: column; align-items: center;
            margin: 0; padding: 0; height: 100vh;
            overflow: hidden; touch-action: manipulation;
        }

        /* 遊戲區域 */
        #game-container {
            position: relative;
            width: 350px; height: 350px;
            margin-top: 50px;
            border: 1px solid var(--re-dim);
            background: rgba(0, 15, 8, 0.5);
        }

        /* 背景電流層 (在最底層) */
        #circuit-canvas {
            position: absolute; top: 0; left: 0;
            z-index: 1; pointer-events: none; /* 確保不擋點擊 */
        }

        /* 符號按鈕層 (在最頂層) */
        .node {
            position: absolute;
            width: 70px; height: 70px; /* 增大點擊區域 */
            display: flex; justify-content: center; align-items: center;
            z-index: 999; /* 確保在最上面 */
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }

        .node-symbol {
            font-size: 38px;
            color: var(--re-dim);
            transition: all 0.2s;
            pointer-events: none; /* 符號本身不吃點擊，讓外層 Node 接收 */
        }

        /* 發光狀態 */
        .node.powered .node-symbol {
            color: var(--re-green);
            text-shadow: 0 0 20px var(--re-green), 0 0 10px #fff;
        }

        /* 中心電源 */
        .core {
            position: absolute; top: 155px; left: 155px;
            width: 40px; height: 40px; background: #fff;
            border-radius: 50%; z-index: 100;
            box-shadow: 0 0 20px #fff;
            pointer-events: none;
        }

        .status { margin-top: 20px; font-size: 14px; letter-spacing: 2px; }
    </style>
</head>
<body>

    <div class="status">POWER CALIBRATION: <span id="access-count">0</span> / 4</div>

    <div id="game-container">
        <canvas id="circuit-canvas" width="350" height="350"></canvas>
        <div class="core"></div>
    </div>

    <div style="margin-top:40px; font-size:12px; color:#444;">TAP SYMBOLS TO ROTATE</div>

<script>
    const container = document.getElementById('game-container');
    const canvas = document.getElementById('circuit-canvas');
    const ctx = canvas.getContext('2d');

    // 定義 1.jpg 中的十字佈局
    const nodeData = [
        { id: 0, r: 1, dir: 'N', type: '┳', rot: 0, powered: false },
        { id: 1, r: 1, dir: 'S', type: '┗', rot: 0, powered: false },
        { id: 2, r: 2, dir: 'W', type: '┣', rot: 0, powered: false },
        { id: 3, r: 2, dir: 'E', type: '┓', rot: 0, powered: false },
        { id: 4, r: 3, dir: 'N', type: '╋', rot: 0, powered: false },
        { id: 5, r: 3, dir: 'S', type: '┳', rot: 0, powered: false }
    ];

    function init() {
        nodeData.forEach(data => {
            const btn = document.createElement('div');
            btn.className = 'node';
            
            // 計算佈局位置 (稍微偏移讓符號居中於點擊盒)
            let x = 140, y = 140;
            const dist = data.r * 45;
            if(data.dir === 'N') y -= dist;
            if(data.dir === 'S') y += dist;
            if(data.dir === 'W') x -= dist;
            if(data.dir === 'E') x += dist;

            btn.style.left = x + 'px';
            btn.style.top = y + 'px';
            
            const span = document.createElement('span');
            span.className = 'node-symbol';
            span.innerHTML = data.type;
            btn.appendChild(span);
            
            // 隨機初始角度
            data.rot = Math.floor(Math.random() * 4) * 90;
            span.style.transform = `rotate(${data.rot}deg)`;

            // 綁定點擊事件
            btn.onclick = function() {
                data.rot += 90;
                span.style.transform = `rotate(${data.rot}deg)`;
                
                // 觸覺反饋
                if (window.navigator.vibrate) window.navigator.vibrate(20);
                
                updateLogic();
            };

            container.appendChild(btn);
            data.el = btn;
        });

        requestAnimationFrame(drawLines);
        updateLogic();
    }

    function updateLogic() {
        let activeCount = 0;
        nodeData.forEach(n => {
            // 簡化邏輯：如果符號轉到 0 或 180 度，視為「導通」
            // 這部分可以根據 1.jpg 的正確路徑進行精確配對
            const isCorrect = (n.rot % 180 === 0);
            n.powered = isCorrect;
            n.el.classList.toggle('powered', isCorrect);
            if(isCorrect) activeCount++;
        });

        document.getElementById('access-count').innerText = Math.min(activeCount, 4);
    }

    function drawLines() {
        ctx.clearRect(0, 0, 350, 350);
        
        // 繪製背景固定電路
        ctx.strokeStyle = '#163a24';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(175, 40); ctx.lineTo(175, 310);
        ctx.moveTo(40, 175); ctx.lineTo(310, 175);
        ctx.stroke();

        // 繪製發光電流效果
        const time = Date.now() / 400;
        ctx.strokeStyle = '#3cf08d';
        ctx.lineWidth = 3;
        ctx.shadowBlur = 10;
        ctx.shadowColor = '#3cf08d';
        ctx.setLineDash([15, 10]);
        ctx.lineDashOffset = -time * 30;

        nodeData.forEach(n => {
            if(n.powered) {
                ctx.beginPath();
                ctx.moveTo(175, 175);
                // 畫一條線到符號中心
                ctx.lineTo(parseInt(n.el.style.left)+35, parseInt(n.el.style.top)+35);
                ctx.stroke();
            }
        });

        requestAnimationFrame(drawLines);
    }

    init();
</script>
</body>
</html>

