<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>CIRCUIT CALIBRATION</title>

<style>
@font-face {
  font-family: "RE4";
  src: url("./resident_evil_4_remake_font_by_snakeyboy_df7kacs.ttf");
}

html, body {
  margin: 0;
  background: #050807;
  height: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
  font-family: "RE4", monospace;
}

#panel {
  border: 4px solid #18ff9c;
  padding: 12px;
  background: #04140d;
}

canvas {
  background: #000;
  display: block;
}

#ui {
  margin-top: 8px;
  color: #18ff9c;
  font-size: 14px;
  text-align: center;
  letter-spacing: 1px;
}
</style>
</head>

<body>
<div id="panel">
  <canvas id="game" width="420" height="420"></canvas>
  <div id="ui">INSUFFICIENT POWER. CALIBRATION REQUIRED.</div>
</div>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const ui = document.getElementById("ui");

const GRID = 5;
const CELL = 84;
const CENTER = 2;

// 方向 bitmask
// 1 = 上, 2 = 右, 4 = 下, 8 = 左
const TILES = [
  0,
  1 | 4,       // │
  2 | 8,       // ─
  1 | 2 | 4 | 8 // ┼
];

let board = [];

// ===== 初始化關卡（手動設計一關）=====
function initLevel() {
  board = [
    [0, 0, 1, 0, 0],
    [0, 2, 3, 2, 0],
    [1, 3, 3, 3, 1],
    [0, 2, 3, 2, 0],
    [0, 0, 1, 0, 0]
  ];
}

function rotate(x, y) {
  let v = board[y][x];
  if (v === 0) return;

  // bit rotate 90°
  let n = 0;
  if (v & 1) n |= 2;
  if (v & 2) n |= 4;
  if (v & 4) n |= 8;
  if (v & 8) n |= 1;

  board[y][x] = n;
}

function drawTile(x, y, mask) {
  if (!mask) return;

  const cx = x * CELL + CELL / 2;
  const cy = y * CELL + CELL / 2;

  ctx.strokeStyle = "#18ff9c";
  ctx.lineWidth = 4;
  ctx.beginPath();

  if (mask & 1) { ctx.moveTo(cx, cy); ctx.lineTo(cx, cy - 30); }
  if (mask & 2) { ctx.moveTo(cx, cy); ctx.lineTo(cx + 30, cy); }
  if (mask & 4) { ctx.moveTo(cx, cy); ctx.lineTo(cx, cy + 30); }
  if (mask & 8) { ctx.moveTo(cx, cy); ctx.lineTo(cx - 30, cy); }

  ctx.stroke();
}

function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  for (let y = 0; y < GRID; y++) {
    for (let x = 0; x < GRID; x++) {
      drawTile(x, y, board[y][x]);
    }
  }
}

// ===== 電力檢查（從上方中心流到下方中心）=====
function checkPower() {
  const visited = Array.from({ length: GRID }, () =>
    Array(GRID).fill(false)
  );

  function dfs(x, y) {
    if (x < 0 || y < 0 || x >= GRID || y >= GRID) return false;
    if (visited[y][x]) return false;
    visited[y][x] = true;

    const mask = board[y][x];
    if (!mask) return false;

    if (y === GRID - 1 && x === CENTER && (mask & 4)) return true;

    if ((mask & 1) && y > 0 && (board[y - 1][x] & 4))
      if (dfs(x, y - 1)) return true;

    if ((mask & 4) && y < GRID - 1 && (board[y + 1][x] & 1))
      if (dfs(x, y + 1)) return true;

    if ((mask & 2) && x < GRID - 1 && (board[y][x + 1] & 8))
      if (dfs(x + 1, y)) return true;

    if ((mask & 8) && x > 0 && (board[y][x - 1] & 2))
      if (dfs(x - 1, y)) return true;

    return false;
  }

  const success = dfs(CENTER, 0);
  ui.textContent = success
    ? "POWER STABLE. SYSTEM ONLINE."
    : "INSUFFICIENT POWER. CALIBRATION REQUIRED.";
}

// ===== 點擊操作 =====
canvas.addEventListener("click", e => {
  const rect = canvas.getBoundingClientRect();
  const x = Math.floor((e.clientX - rect.left) / CELL);
  const y = Math.floor((e.clientY - rect.top) / CELL);

  rotate(x, y);
  draw();
  checkPower();
});

// ===== 啟動 =====
initLevel();
draw();
checkPower();
</script>
</body>
</html>
